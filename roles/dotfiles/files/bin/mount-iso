#!/usr/bin/env bash

mountiso() {
  sudo modprobe nbd
  img=$(find "$IMG" -type f | dmenu -l 5) || exit
  connected=$(lsblk -l | awk '/nbd.*disk/ {print $1}')
  if [ "$connected" ]; then
    dev=$(find /dev | grep -E "nbd[0-9]{1,2}$" | grep -v "$connected" | dmenu -l 5) || exit
  else 
    dev=$(find /dev | grep -E "nbd[0-9]{1,2}$" | dmenu -l 5) || exit
  fi
  sudo qemu-nbd -c "$dev" "$img"
  parts=$(lsblk -l | grep $(basename "$dev" -a) | awk '/nbd.*part/ {print $1}')
  for part in $parts; do
    sudo mkdir "$HOME/mnt/$part"
    sudo mount "/dev/$part" "$HOME/mnt/$part"
  done
}

unmountiso() {
  dev=$(lsblk -l | awk '/nbd.*disk/ {printf "/dev/%s", $1}' | dmenu -l 5) || exit
  parts=$(lsblk -l | grep $(basename "$dev" -a) | awk '/nbd.*part/ {print $1}')
  for part in $parts; do
    sudo umount "/mnt/$part"
  done
  sudo qemu-nbd -d "$dev"
}
